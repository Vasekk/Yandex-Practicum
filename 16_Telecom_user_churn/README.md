# Модель оттока клиентов оператора связи (проект закончен)

## Задача проекта

Оператор связи «Ниединогоразрыва.ком» предоставляет два основных типа услуг: Стационарную телефоннию и Интернет. Оператор хочет научиться прогнозировать отток клиентов (Если выяснится, что пользователь планирует уйти, ему будут предложены промокоды и специальные условия.)

Предоставленные оператором данные актуальны на 01.02.20 и хранятся в папке `/datasets/final_provider/`, содержат полученную из разных источников информацию:

1. о контрактах (`contract.csv`): 
- BeginDate – дата начала пользования услугами,
- EndDate – дата окончания пользования услугами,
- Type – тип оплаты: ежемесячный, годовой и двухгодовой,
- PaperlessBilling – электронный документ об оплате,
- PaymentMethod – способ оплаты,
- MonthlyCharges – ежемесячные траты на услуги,
- TotalCharges – всего потрачено денег на услуги

2. о клиентах(`personal.csv`):
- gender - пол
- Senior Citizen – наличие пенсионного статуса по возрасту
- Partner – наличие супруга(и)
- Dependents – наличие иждивенцев

3. об услугах интернета (`internet.csv`)
- InternetService - тип подключения (оптика или dsl)
- OnlineSecurity - блокировка небезопасных сайтов
- OnlineBackup - облачное хранилище файлов для резервного копирования данных
- DeviceProtection - антивирус 
- TechSupport - выделенная линия технической поддержки
- StreamingTV - стриминговое телевидение 
- StreamingMovies - каталог фильмов

4. об услугах телефонии (`phone.csv`):
- MultipleLines – наличие возможности ведения параллельных линий во время звонка

*Во всех файлах столбец customerID содержит код клиента.*

## План работы:
1. Исседовательский анализ данных
2. Подготовка признаков
3. Обучение моделей 
4. Подбор гиперпараметров

## Библиотеки
`pandas` `numpy` `seaborn` `matplotlib` `optuna` `sklearn` `lightgbm` `catboost` `imblearn`

## Итоги исследования

В ходе работы было выполнено:

1. загружены и проанализированы исходные данные. Данные содержат информацию 
- о контрактах: BeginDate – дата начала пользования услугами, EndDate – дата окончания пользования услугами, Type – тип оплаты: ежемесячный, годовой и тд, PaperlessBilling – электронный документ об оплате, PaymentMethod – способ оплаты, MonthlyCharges – ежемесячные траты на услуги, TotalCharges – всего потрачено денег на услуги
о клиентах: gender - пол Senior Citizen – наличие пенсионного статуса по возрасту Partner – наличие супруга(и) Dependents – наличие иждивенцев

- об услугах интернета InternetService - тип подключения OnlineSecurity - блокировка небезопасных сайтов OnlineBackup - облачное хранилище файлов для резервного копирования данных DeviceProtection - антивирус TechSupport - выделенная линия технической поддержки StreamingTV - стриминговое телевидение StreamingMovies - каталог фильмов

- об услугах телефонии: MultipleLines – наличие возможности ведения параллельных линий во время звонка

- Количество записей о контрактах и клиентах совпадает(7043), записей об услугах интернета и телефонии меньше, что обусловлено, тем что часть клиентов пользуется только одной услугой. Проверено, что нет записей о клиентах, которые не пользуются ни одной услугой. В данных отсутствуют явные пропуски и явные дубликаты. У клиентов зарегистрировавщихся в день выгрузки базы отсутствовала запись о суммарных тратах, заполнена нулями. Названия столбцов приведены к змеиному регистру.

Выделены признак "Время жизни клиента" и целевой признак "Клиент ушел".

2. Подготовлены признаки для обучения моделей:
данные объеденены в один датафрейм,
заполнены появившиеся у клиентов с одной услугой пропуски во второй услуге,
сгенерированы новые признаки: периодирчость оплаты в месяцах, используется ли услуга интернета, обе услуги, количество используемых клиентом услуг.
закодированы категориальные признаки прямым кодированием;
подготовлены обучающая и тестовая выборки.

3. С учетом дисбаланса классов обучены модели CatBoostClassifier, LGBMClassifier, DecisionTreeClassifier, RandomForestClassifier, LogisticRegression.
Рассмотрены 4 метода устранения дисбаланса классов: 1) встроенная в модели балансировка, 2) dowsampling, 3) upsampling SMOTE и 4) RandomOverSampler. 
Наибольшие метрики получаются при использовании RandomOverSampler для моделей LGBMC (0.8917 и 8906) и CBC (0.8878 и 8872). Но наибольшее Accuracy для SMOTE, примерно на 2% больше чем для RandomOverSampler, а Roc-auc меньше на 0.2 %. Также отмечено, что при использовании скалера перед SMOTE метрики деревянных моделей увеличиваются. 

Рассмотрена значимость признаков для 3 лучших моделей и для двух методов балансировки. Значимость признаков варьируется от параметров, поэтому сложно выделить топ5 (или 10) наиболее значимых признаков. Самый значимый признак - время жизни клиентов. Максимальные метрики ROC-AUC наблюдаются при обучении на 1-6 признаках.

5. Выполнен подбор гиперпараметров для трех лучших моделей.
При подборе гипермараметров для определения наиболее значимых признаков и их количества с учетом их взаимной информации использован GenericUnivariateSelect с параметрами score_func=mutual_info_classif, mode='k_best'.
Для подбора гиперпараметров использовались методы GridSearchCV и Optuna.

**Наибольшая метрика ROC-AUC__cv = 0.9514 (accuracy_cv = 0.8834) получена для модели CatBoostClassifier с балансировкой RandomOverSampler, параметры модели: 'n_estimators': 1020, 'max_depth': 2, 'learning_rate': 0.28; для модели определено оптимальное количество признаков -4. Разработанная модель позволит прогнозировать отток клиентов оператора связи «Ниединогоразрыва.ком». Для прогнозирования необходимы признаки: 1) Время жизни клиента, 2) способ оплаты, 3) тип интернет подключения.** 

**Метрики на тестовой выборке:**
1. ROC-AUC = 0.8652, 
2. accuracy = 0.8829.

3. Матрица ошибок

|922|97|
|:-|:-----|
|**68**|**322**|

 т.е. верно предсказано, что: ушло 322 чел, 922 чел. остались; ошибочно предсказано, что 97 ушли и 68 остались.
 
4. Полнота 0.8256, т.е. модель предсказала 82,56 % клиентов, которые ушли, из всех ушедших. 
5. Точность 0.7685, т.е. модель 76,85 % из предсказанных клиентов действительно ушли, но 23,15% остались.
6. Мера F1 0.7960м


